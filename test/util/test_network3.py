#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import matplotlib.pyplot as plt
import sys
import tracklib as tkl
import unittest
from netmatcher import (createNetwork, filtreNoeudSimple, deleteSmallEdge)


class TestUtilNetwork3(unittest.TestCase):
    

    def setUp (self):

        tkl.NetworkReader.counter = 1

        self.collection = tkl.TrackCollection()
        # wkt1 = 'LINESTRING (949190.440013282 6511326.90100122,949192.469283904 6511326.93661571)'
        wkt1 = 'LINESTRING (949214.377868637 6511380.8810175,949212.312684316 6511380.87142613)'
        wkt2 = 'LINESTRING (949192.469283904 6511326.93661571,949194.57382575 6511324.9494055)'
        wkt3 = 'LINESTRING (949212.312684316 6511380.87142613,949207.130837049 6511385.84491581)'
        wkt4 = 'LINESTRING (949208.162135377 6511417.0882351,949205.417211024 6511417.70140535)'
        wkt5 = 'LINESTRING (949205.417211024 6511417.70140535,949199.847571821 6511414.27099233)'
        wkt6 = 'LINESTRING (949191.463449323 6511339.90933966,949193.461437139 6511339.93471666)'
        wkt7 = 'LINESTRING (949197.479388432 6511385.87637029,949199.541480628 6511385.86679327)'
        wkt8 = 'LINESTRING (949193.461437139 6511339.93471666,949197.480407873 6511336.12866278)'
        wkt9 = 'LINESTRING (949199.541480628 6511385.86679327,949204.410301195 6511390.53461185)'
        wkt10 = 'LINESTRING (949210.355972532 6511366.87425736,949208.386910598 6511366.86682868)'
        wkt11 = 'LINESTRING (949208.386910598 6511366.86682868,949205.635395413 6511369.52236108)'
        wkt12 = 'LINESTRING (949192.505598351 6511332.93611503,949194.498556662 6511332.97109222)'
        wkt13 = 'LINESTRING (949194.498556662 6511332.97109222,949198.401726711 6511329.3104336)'
        wkt14 = 'LINESTRING (949194.57382575 6511324.9494055,949194.64044076 6511324.94972845)'
        wkt15 = 'LINESTRING (949194.64044076 6511324.94972845,949198.406617896 6511328.61880023)'
        wkt16 = 'LINESTRING (949202.28637508 6511425.00392918,949198.510890675 6511424.11841349)'
        wkt17 = 'LINESTRING (949204.265520567 6511410.74565316,949199.954309477 6511411.75133597)'
        wkt18 = 'LINESTRING (949204.044250973 6511316.66988958,949201.409141935 6511317.30146626)'
        wkt19 = 'LINESTRING (949200.545925985 6511313.69989537,949202.415033957 6511310.62355809)'
        wkt20 = 'LINESTRING (949200.545925985 6511313.69989537,949201.409141935 6511317.30146626)'
        wkt21 = 'LINESTRING (949204.013623641 6511402.88278974,949203.114159487 6511403.81656946)'
        wkt22 = 'LINESTRING (949204.013623641 6511402.88278974,949202.68488329 6511397.31595498)'
        wkt23 = 'LINESTRING (949196.612586721 6511430.90571939,949198.510890675 6511424.11841349)'
        wkt24 = 'LINESTRING (949198.530648085 6511404.72563867,949199.310542042 6511403.9697951)'
        wkt25 = 'LINESTRING (949198.530648085 6511404.72563867,949199.954309477 6511411.75133597)'
        wkt26 = 'LINESTRING (949205.635395413 6511369.52236108,949204.425840567 6511369.51615435)'
        wkt27 = 'LINESTRING (949199.410471774 6511322.19670956,949200.41279014 6511321.15340294)'
        wkt28 = 'LINESTRING (949199.410471774 6511322.19670956,949199.409950944 6511327.57423495)'
        wkt29 = 'LINESTRING (949199.409950944 6511327.57423495,949198.406617896 6511328.61880023)'
        wkt30 = 'LINESTRING (949203.414979292 6511362.1924342,949203.415537635 6511363.65037818)'
        wkt31 = 'LINESTRING (949203.414979292 6511362.1924342,949202.413426372 6511361.15052117)'
        wkt32 = 'LINESTRING (949203.415537635 6511363.65037818,949204.419005571 6511364.68541887)'
        wkt33 = 'LINESTRING (949201.411423462 6511352.24572318,949201.412547942 6511353.6543852)'
        wkt34 = 'LINESTRING (949201.411423462 6511352.24572318,949199.414418131 6511348.97040245)'
        wkt35 = 'LINESTRING (949201.412547942 6511353.6543852,949202.408886516 6511354.68141684)'
        wkt36 = 'LINESTRING (949201.409141935 6511317.30146626,949200.414215794 6511318.67962298)'
        wkt37 = 'LINESTRING (949201.409141935 6511317.30146626,949201.409141935 6511317.30146626)'
        wkt38 = 'LINESTRING (949197.480407873 6511336.12866278,949198.410038153 6511336.13516213)'
        wkt39 = 'LINESTRING (949207.130837049 6511385.84491581,949207.129601818 6511385.84491581)'
        wkt40 = 'LINESTRING (949207.129601818 6511385.84491581,949205.411020298 6511384.19457284)'
        wkt41 = 'LINESTRING (949203.114159487 6511403.81656946,949199.310542042 6511403.9697951)'
        wkt42 = 'LINESTRING (949198.750087585 6511415.94143344,949199.847571821 6511414.27099233)'
        wkt43 = 'LINESTRING (949198.750087585 6511415.94143344,949198.510890675 6511424.11841349)'
        wkt44 = 'LINESTRING (949204.049525372 6511310.18868249,949202.415033957 6511310.62355809)'
        wkt45 = 'LINESTRING (949204.049525372 6511310.18868249,949204.409393807 6511309.59586934)'
        wkt46 = 'LINESTRING (949202.68488329 6511397.31595498,949202.892010539 6511396.96921664)'
        wkt47 = 'LINESTRING (949198.401726711 6511329.3104336,949198.410038153 6511336.13516213)'
        wkt48 = 'LINESTRING (949198.401726711 6511329.3104336,949198.401726711 6511329.3104336)'
        wkt49 = 'LINESTRING (949204.367101005 6511378.48900773,949204.425840567 6511369.51615435)'
        wkt50 = 'LINESTRING (949204.367101005 6511378.48900773,949205.410459915 6511379.57524375)'
        wkt51 = 'LINESTRING (949204.415054556 6511396.04967941,949204.038255299 6511396.67295607)'
        wkt52 = 'LINESTRING (949204.415054556 6511396.04967941,949204.410301195 6511390.53461185)'
        wkt53 = 'LINESTRING (949198.410876306 6511346.53382877,949198.410038153 6511336.13516213)'
        wkt54 = 'LINESTRING (949198.410876306 6511346.53382877,949199.413638103 6511347.57763091)'
        wkt55 = 'LINESTRING (949204.411603338 6511298.18927073,949204.409393807 6511309.59586934)'
        wkt56 = 'LINESTRING (949204.410301195 6511390.53461185,949204.410301195 6511390.53461185)'
        wkt57 = 'LINESTRING (949204.410301195 6511390.53461185,949204.411034349 6511385.23565347)'
        wkt58 = 'LINESTRING (949204.411034349 6511385.23565347,949205.411020298 6511384.19457284)'
        wkt59 = 'LINESTRING (949200.41279014 6511321.15340294,949200.414215794 6511318.67962298)'
        wkt60 = 'LINESTRING (949198.406617896 6511328.61880023,949198.401726711 6511329.3104336)'
        wkt61 = 'LINESTRING (949202.408886516 6511354.68141684,949202.413426372 6511361.15052117)'
        wkt62 = 'LINESTRING (949204.419005571 6511364.68541887,949204.425840567 6511369.51615435)'
        wkt63 = 'LINESTRING (949202.892010539 6511396.96921664,949204.038255299 6511396.67295607)'
        wkt64 = 'LINESTRING (949199.954309477 6511411.75133597,949199.847571821 6511414.27099233)'
        wkt65 = 'LINESTRING (949205.410459915 6511379.57524375,949205.411020298 6511384.19457284)'
        wkt66 = 'LINESTRING (949199.413638103 6511347.57763091,949199.414418131 6511348.97040245)'

        WKTs = [wkt1, wkt2, wkt3, wkt4, wkt5, wkt6, wkt7, wkt8, wkt9, wkt10,
                wkt11, wkt12,wkt13, wkt14, wkt15, wkt16, wkt17,
                wkt18, wkt19, wkt20, wkt21, wkt22, wkt23, wkt24,
                wkt25, wkt26, wkt27, wkt28, wkt29, wkt30, wkt31, wkt32, wkt33,
                wkt34, wkt35, wkt36, wkt37, wkt38, wkt39, wkt40, wkt41, wkt42,
                wkt43, wkt44, wkt45, wkt46, wkt47, wkt48, wkt49, wkt50,
                wkt51, wkt52, wkt53, wkt54, wkt55, wkt56, wkt57, wkt58, wkt59,
                wkt60, wkt61, wkt62, wkt63, wkt64, wkt65, wkt66]
        for wkt in WKTs:
            track = tkl.TrackReader().parseWkt(wkt)
            if track.size() < 2 :
                continue
            self.collection.addTrack(track)


    def plotNet(self, network, vnode=True):

        network.plot()

        for eid in network.getIndexEdges():
            edge = network.EDGES[eid]
            x1 = edge.geom.getFirstObs().position.getX()
            y1 = edge.geom.getFirstObs().position.getY()
            x2 = edge.geom.getLastObs().position.getX()
            y2 = edge.geom.getLastObs().position.getY()
            plt.text((x1+x2)/2, (y1+y2)/2, str(eid), fontsize=14)

        for nid in network.getIndexNodes():
            node = network.NODES[nid]
            x = node.coord.getX()
            y = node.coord.getY()
            if vnode:
                plt.text(x, y, str(nid), fontsize=14, color='C1')

        # ax.set_xlim([949490, 949510])
        # ax.set_ylim([6511200, 6511220])
        plt.show()

        # print ('Number of edges = ', len(network.EDGES))
        # print ('Number of nodes = ', len(network.NODES))
        # print ('Total length of all edges = ', network.totalLength())




    def testSquelette(self):

        tolerance = 0.5
        network = createNetwork(self.collection, tolerance)

        self.plotNet(network, False)

        self.assertEqual(len(network.EDGES), 66, "Number of edges")
        self.assertEqual(len(network.NODES), 67, "Number of nodes")

        # on compte les arcs en doublons


        filtreNoeudSimple(network)

        threshold = 50
        nb = deleteSmallEdge(network, threshold)
        filtreNoeudSimple(network)
        nb = deleteSmallEdge(network, threshold)

        self.plotNet(network)





if __name__ == '__main__':
    suite = unittest.TestSuite()

    suite.addTest(TestUtilNetwork3("testSquelette"))

    runner = unittest.TextTestRunner()
    runner.run(suite)
